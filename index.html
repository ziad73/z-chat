<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Rooms</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
      height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: #075e54;
      color: white;
      padding: 20px;
      border-radius: 10px 10px 0 0;
      text-align: center;
    }

    .header small {
      display: block;
      margin-top: 5px;
      opacity: 0.8;
      font-size: 12px;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .search-box {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .create-room {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .create-room input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 14px;
    }

    .create-room button {
      background: #075e54;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
    }

    .create-room button:hover {
      background: #064d45;
    }

    .room-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .room-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .room-item:hover {
      background: #e9ecef;
      border-color: #075e54;
    }

    .room-name {
      font-weight: bold;
      font-size: 16px;
      color: #075e54;
    }

    .room-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .message {
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
      background: #fff;
      border: 1px solid #ddd;
    }

    .message-info {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    .input-area input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 25px;
      outline: none;
      font-size: 14px;
    }

    .input-area input[type="text"]:first-child {
      flex: 1;
    }

    .input-area button {
      background: #075e54;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
    }

    .input-area button:hover {
      background: #064d45;
    }

    .status {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      color: #666;
    }

    .status.connected {
      color: #075e54;
    }

    .status.error {
      color: #d32f2f;
    }

    .hidden {
      display: none;
    }

    .empty-state {
      text-align: center;
      color: #666;
      padding: 40px 20px;
    }

    .info-message {
      text-align: center;
      color: #666;
      padding: 40px 20px;
      font-size: 14px;
    }

    /* popup modal */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .popup {
      background: white;
      padding: 25px 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 350px;
      text-align: center;
      animation: scaleIn 0.25s ease-out;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .popup h3 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #075e54;
    }

    .popup button {
      margin-top: 15px;
      padding: 10px 18px;
      background: #075e54;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
    }

    .popup button:hover {
      background: #064d45;
    }

    .hidden {
      display: none !important;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.7);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- Room List Screen -->
  <div class="container" id="roomListScreen">
    <div class="header">
      <h2>Chat Rooms</h2>
      <small>Create or join a chat room</small>
    </div>
    <div class="status" id="status">Setting up...</div>
    <div class="content">
      <div class="create-room">
        <input type="text" id="newRoomName" placeholder="Room name..." maxlength="30" />
        <button onclick="createRoom()">Create</button>
      </div>
      <input type="text" id="searchBox" class="search-box" placeholder="Search for exact room name..." />
      <div class="room-list" id="roomList"></div>
      <div class="info-message" id="infoMessage">
        <p>üîç Enter the exact room name to find and join a chat</p>
      </div>
      <div class="empty-state hidden" id="emptyState">
        <p>No room found with that name</p>
      </div>
    </div>
  </div>

  <!-- Chat Screen -->
  <div class="container hidden" id="chatScreen">
    <div class="header">
      <button class="back-btn" onclick="leaveRoom()">‚Üê Back</button>
      <h2 id="currentRoomName">Chat Room</h2>
      <small>Public chat room</small>
    </div>
    <div class="content">
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="nameInput" placeholder="Your name..." value="Anonymous" />
        <div class="input-row">
          <input type="text" id="messageInput" placeholder="Type a message..." />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Modal -->
  <div id="popupOverlay" class="overlay hidden">
    <div class="popup">
      <h3>Room Created üéâ</h3>
      <p>Your room has been created successfully.</p>
      <p>Search for the room name to join it.</p>
      <button onclick="closePopup()">Got it</button>
    </div>
  </div>

  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      onValue,
      set,
      query,
      limitToLast,
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEcU2zCfvGI2BYATrrGgzXjf2N1pKTQK8",
      authDomain: "z25-chat.firebaseapp.com",
      databaseURL:
        "https://z25-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "z25-chat",
      storageBucket: "z25-chat.firebasestorage.app",
      messagingSenderId: "426948646366",
      appId: "1:426948646366:web:24dab1a685219742bd394f",
    };

    let db;
    let currentRoom = null;
    let allRooms = [];
    let messageListener = null;

    // Initialize Firebase
    try {
      const app = initializeApp(firebaseConfig);
      db = getDatabase(app);

      // Listen for rooms
      const roomsRef = ref(db, "rooms");
      onValue(roomsRef, (snapshot) => {
        allRooms = [];
        snapshot.forEach((child) => {
          allRooms.push({
            id: child.key,
            ...child.val(),
          });
        });
        displayRooms();
      });

      document.getElementById("status").textContent = "‚úì Connected";
      document.getElementById("status").className = "status connected";
    } catch (error) {
      document.getElementById("status").textContent = "‚úó Setup required";
      document.getElementById("status").className = "status error";
      console.error("Firebase error:", error);
    }

    // Create new room
    window.createRoom = function () {
      const input = document.getElementById("newRoomName");
      const roomName = input.value.trim();

      if (roomName && db) {
        const roomsRef = ref(db, "rooms");
        const newRoomRef = push(roomsRef);

        set(newRoomRef, {
          name: roomName,
          created: new Date().toISOString(),
          messageCount: 0,
        });

        input.value = "";

        // Show success popup
        document.getElementById("popupOverlay").classList.remove("hidden");
      }
    };

    // Popup modal
    window.closePopup = function () {
      document.getElementById("popupOverlay").classList.add("hidden");
    };

    // Display rooms
    function displayRooms(filter = "") {
      const container = document.getElementById("roomList");
      const emptyState = document.getElementById("emptyState");
      const infoMessage = document.getElementById("infoMessage");

      container.innerHTML = "";

      // If no search term, show info message and hide rooms
      if (!filter.trim()) {
        infoMessage.classList.remove("hidden");
        emptyState.classList.add("hidden");
        return;
      }

      // Hide info message when searching
      infoMessage.classList.add("hidden");

      // Find exact match only
      const exactMatch = allRooms.find(
        (room) => room.name.toLowerCase() === filter.toLowerCase(),
      );

      if (!exactMatch) {
        emptyState.classList.remove("hidden");
        return;
      }

      emptyState.classList.add("hidden");

      // Show only the exact match
      const div = document.createElement("div");
      div.className = "room-item";
      div.onclick = () => joinRoom(exactMatch.id, exactMatch.name);
      div.innerHTML = `
                <div class="room-name">${exactMatch.name}</div>
                <div class="room-info">Messages: ${exactMatch.messageCount || 0}</div>
            `;
      container.appendChild(div);
    }

    // Search rooms
    document.getElementById("searchBox").addEventListener("input", (e) => {
      displayRooms(e.target.value);
    });

    // Join room
    window.joinRoom = function (roomId, roomName) {
      currentRoom = roomId;

      document.getElementById("roomListScreen").classList.add("hidden");
      document.getElementById("chatScreen").classList.remove("hidden");
      document.getElementById("currentRoomName").textContent = roomName;
      document.getElementById("messages").innerHTML = "";

      // Listen for messages in this room
      const messagesRef = ref(db, `rooms/${roomId}/messages`);
      const recentMessages = query(messagesRef, limitToLast(50));

      onChildAdded(recentMessages, (snapshot) => {
        const msg = snapshot.val();
        displayMessage(msg);
      });
    };

    // Leave room
    window.leaveRoom = function () {
      currentRoom = null;
      document.getElementById("chatScreen").classList.add("hidden");
      document.getElementById("roomListScreen").classList.remove("hidden");
    };

    // Display message
    function displayMessage(msg) {
      const container = document.getElementById("messages");
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `
                <div><strong>${msg.user}:</strong> ${msg.text}</div>
                <div class="message-info">${msg.time}</div>
            `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Send message
    window.sendMessage = function () {
      const input = document.getElementById("messageInput");
      const nameInput = document.getElementById("nameInput");
      const text = input.value.trim();
      const name = nameInput.value.trim() || "Anonymous";

      if (text && currentRoom && db) {
        const now = new Date();
        const time = now.toLocaleTimeString();

        const messagesRef = ref(db, `rooms/${currentRoom}/messages`);
        push(messagesRef, {
          user: name,
          text: text,
          time: time,
          timestamp: now.getTime(),
        });

        // Update message count
        const roomRef = ref(db, `rooms/${currentRoom}`);
        onValue(
          roomRef,
          (snapshot) => {
            const room = snapshot.val();
            set(roomRef, {
              ...room,
              messageCount: (room.messageCount || 0) + 1,
              lastMessage: now.toISOString(),
            });
          },
          {onlyOnce: true},
        );

        input.value = "";
      }
    };

    // Send on Enter
    document
      .getElementById("messageInput")
      .addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

    document
      .getElementById("newRoomName")
      .addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          createRoom();
        }
      });
  </script>
</body>

</html>
